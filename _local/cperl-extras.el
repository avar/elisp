(require 'thingatpt)
(require 'perl-things)
(require 'my-macros)
(require 'cperl-test-increment)
(require 'cperl-dump)
(require 'cperl-use)
(require 'cperl-misc)
(require 'cperl-project)
(require 'cperl-moose)
(require 'cperl-reindent)

(defun cperl-run-tests-in-eshell (&optional prefix)
  (interactive "p")
  (let* ((name (file-relative-name (buffer-file-name) (eproject-root)))
         (eshell-buf (eproject-eshell-cd-here prefix)))
    (with-current-buffer eshell-buf
      (goto-char (point-max))
      (eshell-preinput-scroll-to-bottom)
      (if (string-match ".t$" name)
          (insert (format "perl -Ilib %s" name))
        (insert "prove --lib -r -j3 t"))
      (eshell-send-input nil t)
      (eshell-postoutput-scroll-to-bottom))))

(add-hook 'cperl-mode-hook
          (lambda ()
            (local-set-key (kbd "C-c C-l") 'cperl-run-tests-in-eshell)
            (local-set-key "\C-ct" 'increment-test-counter)
            (local-set-key "\C-cu" 'add-use)
            (local-set-key "\C-cmu" 'add-Makefile.PL-requires)
            (local-set-key "\C-cmv" 'visit-Makefile.PL)
            (local-set-key "\C-cd" 'perl-insert-debug-statement)
            (local-set-key "\C-cs" 'insert-self-shift)
            (local-set-key "\C-cT" 'find-tests)
            (local-set-key "\C-cw" 'swap-strict-and-moose)
            (local-set-key "\C-c\C-f" 'ifind-perl-project-file)
            (local-set-key "\C-c\C-p" 'ifind-perl-projects)
            (local-set-key "\C-c510" 'kill-5.10)
            (local-set-key "\C-cr" 'cperl-repl)
            (local-set-key (quote [M-tab]) 'cperl-reindent-hash)
            (local-set-key (kbd "M-C-i") 'cperl-reindent-hash)
            (local-set-key "\C-cq" 'find-module)))

(add-hook 'tt-mode-hook
          (lambda ()
            (local-set-key "\C-c\C-f" 'ifind-perl-project-file)))

(global-set-key "\C-c\C-p" 'ifind-perl-projects)

(provide 'cperl-extras)
